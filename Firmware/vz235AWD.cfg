##VZ235##

######################################################################
# this cfg contains the parameters for the default config as tested for the VZ235 AWD
# the stepper settings are recommended to leave as is, no other settings have been tested as of yet but feel free to test on your own risk
# List of relevant hardware that will work with this cfg:
# fysetc spider V2.2 
# raspberry pi in uart
# LDO 1.8 degree steppers 240AC
# tmc5160 XY
# tmc 2130 (SPI) E+Z
# pt1000 thermistor in mellow NF crazy / volcomosq
# AC silicone bed 
# hextrudort extruder with nema14 17mm version (up current to 0.5-0.6 for 20mm version
#####################################################################
# As of now klipper does not natively support AWD corexy kinematics, for this follow the VZ235 manual.
# you will need to install a fork of klipper: https://github.com/TypQxQ/klipper 
#####################################################################
[include mainsail.cfg]            #configure fluidd.cfg if you run fluid

[mcu]
restart_method: command

serial: /dev/ttyAMA0              # for UART connection
 
[printer]
kinematics: corexy
max_velocity: 800 
max_accel: 10000
max_accel_to_decel: 10000			        
max_z_velocity: 50			
max_z_accel: 350
square_corner_velocity: 15

#####################################################################
#      X/Y Stepper Settings
#####################################################################


[stepper_y]
##	in M1 position
step_pin: PE11
dir_pin: !PE10
enable_pin: !PE9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  
endstop_pin: ^PB13
position_endstop: 0
position_max: 235
homing_speed: 25  
homing_retract_dist: 0


[tmc5160 stepper_y] 
spi_bus: spi4 
cs_pin: PE7
interpolate: false
#diag1_pin: PB14 
run_current: 1.6

spi_speed: 1000000
stealthchop_threshold: 0
driver_IHOLDDELAY: 6
driver_TPOWERDOWN: 10
driver_TBL: 2
driver_TOFF: 4
driver_HEND: 5
driver_HSTRT: 0
driver_tpfd: 0
driver_pwm_autoscale: True
driver_pwm_autograd: True
driver_pwm_freq: 2
driver_PWM_GRAD: 0
driver_PWM_OFS: 0
driver_PWM_REG: 0
driver_PWM_LIM: 0

[stepper_y1]
##	in M5 position
dir_pin: !PC13
enable_pin: !PE5
step_pin: PE6
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200 


[tmc5160 stepper_y1] 
spi_bus: spi4 
cs_pin: PC14 
interpolate: false
#diag1_pin: PB14 
run_current: 1.6

spi_speed: 1000000
stealthchop_threshold: 0
driver_IHOLDDELAY: 6
driver_TPOWERDOWN: 10
driver_TBL: 2
driver_TOFF: 4
driver_HEND: 5
driver_HSTRT: 0
driver_tpfd: 0
driver_pwm_autoscale: True
driver_pwm_autograd: True
driver_pwm_freq: 2
driver_PWM_GRAD: 0
driver_PWM_OFS: 0
driver_PWM_REG: 0
driver_PWM_LIM: 0


[stepper_x]
##	in M2 position
step_pin: PD8
dir_pin: !PB12
enable_pin: !PD9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  
endstop_pin: ^PB14
position_endstop: 0
position_max: 235
homing_speed: 25  
homing_retract_dist: 0

[tmc5160 stepper_x] 
spi_bus: spi4 
cs_pin: PE15
#diag1_pin: PB13
interpolate: false 
run_current: 1.6

spi_speed: 1000000
stealthchop_threshold: 0
driver_IHOLDDELAY: 6
driver_TPOWERDOWN: 10
driver_TBL: 2
driver_TOFF: 4
driver_HEND: 5
driver_HSTRT: 0
driver_tpfd: 0
driver_pwm_autoscale: True
driver_pwm_autograd: True
driver_pwm_freq: 2
driver_PWM_GRAD: 0
driver_PWM_OFS: 0
driver_PWM_REG: 0
driver_PWM_LIM: 0


[stepper_x1]
##	in M6 position
dir_pin: !PE4
enable_pin: !PE3
step_pin: PE2
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  


[tmc5160 stepper_x1] 
spi_bus: spi4 
cs_pin: PC15 
interpolate: false
#diag1_pin: PB14 
run_current: 1.6

spi_speed: 1000000
stealthchop_threshold: 0
driver_IHOLDDELAY: 6
driver_TPOWERDOWN: 10
driver_TBL: 2
driver_TOFF: 4
driver_HEND: 5
driver_HSTRT: 0
driver_tpfd: 0
driver_pwm_autoscale: True
driver_pwm_autograd: True
driver_pwm_freq: 2
driver_PWM_GRAD: 0
driver_PWM_OFS: 0
driver_PWM_REG: 0
driver_PWM_LIM: 0

#####################################################################
#   Z Stepper Settings
#####################################################################

## In Z-MOT Position
[stepper_z]
step_pin: PD14
dir_pin: !PD13
enable_pin: !PD15

rotation_distance: 4
microsteps: 16

endstop_pin: ^PA0
position_endstop: 0
position_max: 240
position_min: -1
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3

[tmc2130 stepper_z] 
spi_bus: spi4 
cs_pin: PD10
#diag1_pin: PB13
interpolate: false 
run_current: 0.5



#####################################################################
#   Extruder
#####################################################################

##	In E0-MOT Position
[extruder]
step_pin: PD5
dir_pin: PD6
enable_pin: !PD4
microsteps: 32
rotation_distance: 4.6
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75

heater_pin: PB15                
sensor_type: PT1000
sensor_pin: PC0                 
#pullup_resistor: 4700
min_temp: 5
max_temp: 400
max_power: 1.0
min_extrude_temp: 40
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721 

[tmc2130 extruder] 
spi_bus: spi4 
cs_pin: PD7
#diag1_pin: PB13
interpolate: false 
run_current: 0.25



#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
##	SSR Pin - In E2 position (no need to wire in Bed position to psu) 
##	if used without SSR wire in bed in and bed out and use PB4
heater_pin: PB3
sensor_type: Generic_3950
sensor_pin: PB0 # Spider v2.x TB Position
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 0.8
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769


#####################################################################
#	Fan Control
#####################################################################

[heater_fan hotend_fan]
##	Hotend Fan - FAN0 Connector
pin: PA13 # Spider v2.x
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
#fan_speed: 1.0

[fan]
##	Print Cooling Fan - FAN1 Connector
pin: PA14 # Spider v2.x
max_power: 1
kick_start_time: 0.5
off_below: 0.10

[heater_fan controller_fan]
##	Controller fan - PB7 (LED-B rgb) Connector
pin: PB7
kick_start_time: 0.5
heater: heater_bed
heater_temp: 45.0

[fan_generic exhaust_fan]
##  Exhaust fan - In fan2 connector
pin: PB2
max_power: 1.0
kick_start_time: 0.5
off_below: 0.10

[fan_generic RSCS]
##  RSCS - In E2 OUT Positon
pin: PC8
max_power: 1.0
kick_start_time: 0.5
off_below: 0.10

#####################################################################
#	LED Control
#####################################################################

[output_pin caselight ]
##  Chamber Lighting - In LED-R position
pin: PB6
pwm: true
shutdown_value: 0
value: 1.0
cycle_time: 0.01


#####################################################################
#	Additional temp sensors
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 10
max_temp: 100


#####################################################################
#	Macros
#####################################################################

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    G28 ; Home all axes
    G1 Z2.0 F3000                   # Move Z Axis up little to prevent scratching of Heat Bed
    G1 X0.1 Y20 Z0.3 F5000.0        # Move to start position
    G1 X0.1 Y200.0 Z0.3 F1500.0 E15 # Draw the first line
    G1 X0.4 Y200.0 Z0.3 F5000.0     # Move to side a little
    G1 X0.4 Y20 Z0.3 F1500.0 E30    # Draw the second line
    G92 E0 ; Reset Extruder
    G1 Z2.0 F3000                   # Move Z Axis up little to prevent scratching of Heat Bed
    G1 X5 Y20 Z0.3 F5000.0          # Move over to prevent blob squish

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    M400                            # wait for buffer to clear
    G92 E0                          # zero the extruder
    G1 E-1.0 F3600                  # retract filament
    G91                             # relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000     # move nozzle to remove stringing
    TURN_OFF_HEATERS
    M220				      # reset feedrate
    M107                            # turn off fan
    G1 Z2 F3000                     # move nozzle up 2mm
    G90                             # absolute positioning
    G0  X110 Y200 F2000             # park nozzle at rear
    M84				      # disable steppers
    


[gcode_macro enable_stepper]
gcode:
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1


[gcode_macro disable-steppers]
gcode:
    m84


## 	Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "Generic_3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"
##   "PT1000"